# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

stages:
  - stage: Build
    displayName: "Build Replacer"
    jobs:
      #Test and build for Linux, Windows and MacOS
      - job: build
        displayName: "Test and build"
        strategy:
          #Use the following Azure build agents and set the os variable (used in artifact name)
          matrix:
            linux:
              imageName: 'ubuntu-latest'
              os: "lin"
            # mac:
            #   imageName: 'macOS-latest'
            #   os: "mac"
            # windows:
            #   imageName: 'windows-latest'
            #   os: "win"
        #Use the Azure vmImage to build the solution
        pool: 
          vmImage: $(imageName)

        steps: 
          #Install rust on the Azure build agent           
          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            displayName: "Install Rust"

          #Run the unit tests of our software. Do this onlyt when install rust succeeded
          - script: |  
              cargo test
            condition: succeeded()
            displayName: "Unit Tests"

          #Build the release. Do this only when tests succeeded
          - script: |
              cargo build --release
            condition: succeeded()
            displayName: "Build Solution"  

          #Copy the binaries to this artifact staging directory called: <os>/<binary>
          - task: CopyFiles@2
            condition: succeeded()
            displayName: "Copy binaries only"
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/target/release/'
              Contents: |
                replacer
                replacer.exe
              TargetFolder: '$(Build.ArtifactStagingDirectory)/'

          #Build the artifect for each os. Name the artidact replace-<os>
          - task: PublishBuildArtifacts@1
            displayName: "Package artifact"
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: replacer-$(os)
              publishLocation: 'Container'
  - stage: deploy
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    displayName:  "Deploy to GIT"
    jobs:
      - job: gitclone
        displayName: "Git Clone"  
        steps:
          - checkout: none
          - script: |
                echo 'Cloning into sources folder at: $(System.ArtifactsDirectory)/commit/replacer'
                git clone https://github.com/rdoetjes/replacer $(System.ArtifactsDirectory)/commit/replacer
            displayName: "Git Clone"
      - job: enrich
        displayName: "Enrich Repo wit artifacts"
        dependsOn: gitclone
        condition: succeeded()
        steps:
          - checkout: none
          - task: DownloadBuildArtifacts@1
            displayName: "Linux"
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'replacer-lin'
              downloadPath: '$(System.ArtifactsDirectory)/commit/replacer/binaries/'
          # - task: DownloadBuildArtifacts@1
          #   displayName: "MacOS"
          #   inputs:
          #     buildType: 'current'
          #     downloadType: 'single'
          #     artifactName: 'replacer-mac'
          #     downloadPath: '$(System.ArtifactsDirectory)/commit/replacer/binaries/'
          # - task: DownloadBuildArtifacts@1
          #   displayName: "Windows"
          #   inputs:
          #     buildType: 'current'
          #     downloadType: 'single'
          #     artifactName: 'replacer/binary/replacer-win'
          #     downloadPath: '$(System.ArtifactsDirectory)/commit/replacer/binaries/'
      - job: push
        dependsOn: enrich
        condition: succeeded()
        displayName: "git commit and push"
        steps:
        - checkout: none
        - task: CmdLine@2
          displayName: 'git push'
          inputs:
            script: |
              cd $(System.ArtifactsDirectory)/commit/replacer/
              git config --global user.email "rdoetjes@phonax.com"
              git config --global user.name "Build Agent"
              git add 'replacer/binary/$(System.ArtifactsDirectory)/*'
              git commit -am "deployed binaries [skip ci]"
              git push
              git tag -a build_$(Build.BuildNumber) -m "BUILD $(Build.BuildNumber)"

      
            