# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

stages:
  - stage: Build
    displayName: "Build Replacer"
    jobs:
      - job: build
        displayName: "Test and build"
        strategy:
          matrix:
            linux:
              imageName: 'ubuntu-latest'
              os: "lin"
            mac:
              imageName: 'macOS-latest'
              os: "mac"
            windows:
              imageName: 'windows-latest'
              os: "win"
        pool: 
          vmImage: $(imageName)
        steps:            
          - script: |
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            displayName: "Install Rust"

          - script: |  
              cargo test
            condition: succeeded()
            displayName: "Unit Tests"

          - script: |
              cargo build --release
            condition: succeeded()
            displayName: "Build Solution"  

          - task: CopyFiles@2
            condition: succeeded()
            displayName: "Copy binaries only"
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/target/release/'
              Contents: |
                replacer
                replacer.exe
              TargetFolder: '$(Build.ArtifactStagingDirectory)/$(os)/'
              
      - job: packaging
        dependsOn: build
        condition: succeeded()
        displayName: "Package artifact"
        steps:
          - task: PublishBuildArtifacts@1
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: replacer-$(os)
              publishLocation: 'Container'